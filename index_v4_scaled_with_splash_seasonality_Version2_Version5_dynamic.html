<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Primus Traders | Empowering Disciplined Traders</title>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<meta name="description" content="Empowering disciplined traders with high-impact USD catalysts, multi‑asset charts (US100, DXY, ES, Gold), NASDAQ COT positioning, curated news and a focused execution journal." />
<meta name="theme-color" content="#f8f5f1" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
<style>
:root{
  --font:'Roboto',system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Arial,sans-serif;
  --fs-1:clamp(.63rem,.57rem + .25vw,.72rem);
  --fs-2:clamp(.70rem,.64rem + .35vw,.83rem);
  --fs-3:clamp(.78rem,.7rem + .5vw,.95rem);
  --fs-4:clamp(1.0rem,.9rem + .9vw,1.35rem);
  --fs-h3:clamp(1.05rem,.9rem + 1.2vw,1.55rem);
  --fs-h2:clamp(1.55rem,1.15rem + 2.2vw,2.25rem);
  --fs-h1:clamp(2.15rem,1.4rem + 3.3vw,3.3rem);
  --lh-tight:1.15;--lh-body:1.52;
  --space-0:0;--space-1:.25rem;--space-2:.5rem;--space-3:.75rem;
  --space-4:1rem;--space-5:1.25rem;--space-6:1.5rem;--space-7:1.9rem;
  --space-8:2.4rem;--space-9:3rem;--space-10:3.8rem;
  --container-max:1220px;
  --radius-sm:6px;--radius-md:14px;--radius-lg:24px;--radius-xl:32px;--radius-full:999px;
  --bg:#f8f5f1;--bg-alt:#f3eee8;
  --surface:#ffffff;--surface-alt:#f6f1ec;--surface-accent:#f1e9e1;
  --border:#e2d7cc;--border-strong:#cfbeaf;
  --text:#2e2721;--text-soft:#6b5f55;--text-faint:#9a8f85;
  --accent:#b27934;--accent-hover:#c6893f;--accent-warm:#d6a357;
  --shadow-sm:0 2px 6px -2px rgba(55,38,21,.18),0 1px 2px rgba(55,38,21,.08);
  --shadow-md:0 14px 34px -16px rgba(55,38,21,.38),0 6px 16px -4px rgba(55,38,21,.22);
  --trans:.28s cubic-bezier(.55,.2,.2,.95);
  --focus-ring:0 0 0 3px rgba(178,121,52,.45);
  --hero-bg:radial-gradient(circle at 32% 25%,#ffffff 0%,#f3ece4 55%,#ece2d8 100%);
  --chart-border:var(--border-strong);
}
body.dark{
  --bg:#12100e;--bg-alt:#1a1613;
  --surface:#1f1b17;--surface-alt:#26211c;--surface-accent:#2c251f;
  --border:#3b352f;--border-strong:#52473e;
  --text:#f2e9e2;--text-soft:#c4b8af;--text-faint:#8b8179;
  --accent:#d1954d;--accent-hover:#e3a55a;--accent-warm:#f0b76d;
  --hero-bg:radial-gradient(circle at 32% 25%,#29221c 0%,#1e1915 55%,#171310 100%);
  --chart-border:#52473e;
  --shadow-sm:0 2px 6px -2px rgba(0,0,0,.55),0 1px 2px rgba(0,0,0,.35);
  --shadow-md:0 14px 34px -18px rgba(0,0,0,.85),0 6px 16px -6px rgba(0,0,0,.6);
}
*{box-sizing:border-box;margin:0;padding:0}
html{font-size:17px;-webkit-text-size-adjust:100%;scroll-behavior:smooth}
body{font-family:var(--font);font-size:var(--fs-3);line-height:var(--lh-body);background:var(--bg);background-image:var(--hero-bg);color:var(--text);-webkit-font-smoothing:antialiased;min-height:100vh;overflow-x:hidden;transition:background .6s, color .6s}
h1,h2,h3{font-weight:900;letter-spacing:-.5px;line-height:var(--lh-tight);margin:0 0 var(--space-4)}
p{margin:0 0 var(--space-4)}
a{color:var(--accent);text-decoration:none;transition:var(--trans)}
a:hover{color:var(--accent-hover)}
:focus-visible{outline:none;box-shadow:var(--focus-ring);border-radius:6px}
.container{max-width:var(--container-max);margin:0 auto;padding:0 clamp(var(--space-4),3vw,var(--space-6))}
.section{padding:var(--space-9) 0 var(--space-8)}
.section + .section{padding-top:var(--space-8)}
/* Header / Nav */
.site-header{position:sticky;top:0;z-index:90;background:rgba(255,255,255,.9);backdrop-filter:blur(9px);border-bottom:1px solid var(--border);box-shadow:0 3px 14px -10px rgba(0,0,0,.35);transition:background .6s,border .6s}
body.dark .site-header{background:rgba(28,24,20,.8);box-shadow:0 3px 14px -10px rgba(0,0,0,.65)}
.nav-wrapper{display:flex;align-items:center;justify-content:space-between;gap:var(--space-4);min-height:72px}
.logo{display:flex;align-items:center;gap:var(--space-3);font-size:var(--fs-3);font-weight:700;color:var(--text);line-height:1;white-space:nowrap}
.logo-mark{width:44px;height:44px;border-radius:16px;background:linear-gradient(135deg,var(--accent),var(--accent-hover) 60%,var(--accent-warm));display:flex;align-items:center;justify-content:center;font-weight:800;font-size:1.05rem;color:#fff;box-shadow:var(--shadow-sm)}
.nav-links{list-style:none;display:flex;align-items:center;gap:var(--space-2);flex-wrap:wrap}
.nav-links a{padding:.55rem .9rem;font-size:var(--fs-2);font-weight:600;border-radius:var(--radius-full);color:var(--text-soft);line-height:1;transition:var(--trans)}
.nav-links a.active,.nav-links a:hover{background:var(--surface-alt);color:var(--text)}
.nav-toggle{display:none;background:none;border:none;flex-direction:column;gap:5px;cursor:pointer;padding:.65rem}
.nav-toggle span{width:28px;height:3px;background:var(--text);border-radius:2px;transition:var(--trans)}
.theme-toggle{margin-left:var(--space-2);background:var(--surface-alt);border:1px solid var(--border-strong);color:var(--accent);padding:.55rem .85rem .5rem;font-size:var(--fs-2);font-weight:600;border-radius:var(--radius-full);cursor:pointer;display:inline-flex;align-items:center;gap:.4rem;transition:var(--trans)}
.theme-toggle:hover{background:var(--accent);color:#fff;border-color:var(--accent)}
body.dark .theme-toggle{background:var(--surface-alt);color:var(--accent)}
@media(max-width:860px){
 .nav-links{position:absolute;top:72px;right:var(--space-4);background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);padding:var(--space-5) var(--space-5) var(--space-4);flex-direction:column;align-items:stretch;gap:var(--space-2);box-shadow:var(--shadow-md);opacity:0;transform:translateY(-10px) scale(.97);pointer-events:none;transition:var(--trans)}
 body.dark .nav-links{background:var(--surface);border-color:var(--border-strong)}
 .nav-links.open{opacity:1;transform:translateY(0) scale(1);pointer-events:auto}
 .nav-toggle{display:flex}
}
/* Hero */
.hero{padding:var(--space-10) 0 var(--space-9);position:relative;overflow:hidden;transition:background .6s}
.hero-grid{display:grid;gap:var(--space-8);grid-template-columns:repeat(auto-fit,minmax(360px,1fr));align-items:start}
.catalyst-pill{display:inline-flex;align-items:center;gap:.45rem;background:var(--surface-alt);border:1px solid var(--border);padding:.5rem .95rem .45rem;font-size:var(--fs-1);font-weight:700;letter-spacing:.75px;text-transform:uppercase;border-radius:var(--radius-full);color:var(--accent)}
.panel{background:linear-gradient(140deg,var(--surface) 0%,var(--surface-alt) 70%,var(--surface-accent));border:1px solid var(--border);border-radius:var(--radius-lg);padding:var(--space-6) var(--space-6) var(--space-5);box-shadow:var(--shadow-sm);display:flex;flex-direction:column;gap:var(--space-4);min-height:100%;transition:var(--trans),background .6s,border .6s}
.panel:hover{transform:translateY(-4px);box-shadow:var(--shadow-md);border-color:var(--accent-hover)}
.subheading{font-size:var(--fs-1);letter-spacing:2px;font-weight:700;text-transform:uppercase;margin:0;color:var(--accent)}
.mini-desc{font-size:var(--fs-2);color:var(--text-soft);margin:0}
.asset-switcher,.tf-switcher{display:flex;flex-wrap:wrap;gap:.5rem;align-items:center}
.asset-switcher button,.tf-switcher button{background:var(--surface-alt);border:1px solid var(--border-strong);padding:.45rem .85rem .4rem;font-size:var(--fs-1);font-weight:600;letter-spacing:.5px;border-radius:var(--radius-full);cursor:pointer;color:var(--text-soft);transition:var(--trans)}
.asset-switcher button.active,.asset-switcher button:hover,.tf-switcher button.active,.tf-switcher button:hover{background:var(--accent);color:#fff;border-color:var(--accent)}
.chart-wrapper{
  flex:1 1 auto;
  min-height:300px;
  height:460px;
  border:1.5px solid var(--chart-border);
  border-radius:16px;
  background:#fff;
  position:relative;
  overflow:hidden;
  display:flex;
  transition:background .6s,border .6s;
}
body.dark .chart-wrapper{background:#1d1915}
.chart-wrapper.loading::after{content:"";position:absolute;inset:0;background:linear-gradient(90deg,rgba(255,255,255,0) 0%,rgba(215,200,185,.6) 50%,rgba(255,255,255,0) 100%);animation:shimmer 1.4s linear infinite;mix-blend-mode:overlay}
body.dark .chart-wrapper.loading::after{background:linear-gradient(90deg,rgba(0,0,0,0) 0%,rgba(90,70,50,.55) 50%,rgba(0,0,0,0) 100%)}
@keyframes shimmer{0%{transform:translateX(-40%)}100%{transform:translateX(120%)}}
@media(max-width:760px){.chart-wrapper{height:380px}}
.btn{--bg:var(--accent);--color:#fff;display:inline-flex;align-items:center;justify-content:center;gap:.5rem;padding:.78rem 1.3rem .72rem;border:none;border-radius:var(--radius-full);font-size:var(--fs-1);letter-spacing:.7px;font-weight:700;text-transform:uppercase;background:var(--bg);color:var(--color);cursor:pointer;box-shadow:0 2px 10px -2px rgba(0,0,0,.2),0 4px 14px -6px rgba(178,121,52,.4);transition:var(--trans)}
.btn:hover{transform:translateY(-2px);background:var(--accent-hover)}
.btn.outline{--bg:var(--surface);--color:var(--accent);background:var(--bg);border:1.6px solid var(--border-strong);box-shadow:none}
.btn.outline:hover{background:var(--accent);color:#fff;border-color:var(--accent)}
.btn.ghost{--bg:var(--surface-alt);--color:var(--accent);border:1.3px solid var(--border);background:var(--bg);color:var(--color)}
.btn.ghost:hover{background:var(--accent);color:#fff;border-color:var(--accent)}
.btn.small{padding:.52rem .9rem .46rem;font-size:var(--fs-1);letter-spacing:.6px;box-shadow:none}
.value-points{list-style:none;padding:0;margin:var(--space-5) 0 0;display:flex;flex-wrap:wrap;gap:var(--space-3);font-size:var(--fs-2);font-weight:600;color:var(--text-soft);letter-spacing:.4px}

/* Mini News widget Hero */
.mini-news-widget{margin-top:var(--space-6);background:var(--surface);border:1px solid var(--border);border-radius:18px;padding:var(--space-5) var(--space-5) var(--space-4);box-shadow:var(--shadow-sm);display:flex;flex-direction:column;gap:var(--space-3);transition:var(--trans),background .6s,border .6s}
body.dark .mini-news-widget{background:var(--surface);border-color:var(--border-strong)}
.mini-news-widget h3{margin:0;font-size:var(--fs-2);letter-spacing:.6px;text-transform:uppercase;font-weight:700;color:var(--accent)}
.mini-news-list{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:.55rem;font-size:var(--fs-2)}
.mini-news-list li{display:flex;gap:.5rem;line-height:1.35}
.mini-news-list li .topic{background:var(--accent);color:#fff;font-size:var(--fs-1);font-weight:600;padding:.18rem .5rem .14rem;border-radius:12px;letter-spacing:.5px;flex:0 0 auto;align-self:flex-start}
.mini-news-list li a{color:var(--text);text-decoration:none;flex:1;font-weight:500}
.mini-news-list li a:hover{color:var(--accent)}
.mini-news-actions{display:flex;align-items:center;justify-content:space-between;margin-top:.25rem}
.mini-refresh-btn{background:var(--surface-alt);border:1px solid var(--border);color:var(--accent);padding:.35rem .65rem .3rem;font-weight:600;border-radius:var(--radius-full);cursor:pointer;transition:var(--trans)}
.mini-refresh-btn:hover{background:var(--accent);color:#fff;border-color:var(--accent)}
body.dark .mini-refresh-btn{background:var(--surface-alt);border-color:var(--border)}
/* Calendar / COT Cards */
.pulse-grid{display:grid;gap:var(--space-7);grid-template-columns:repeat(auto-fit,minmax(360px,1fr));align-items:start}
.card{background:var(--surface);border:1px solid var(--border-strong);border-radius:var(--radius-lg);padding:var(--space-6) var(--space-6) var(--space-5);box-shadow:var(--shadow-sm);display:flex;flex-direction:column;gap:var(--space-4);min-height:100%;transition:var(--trans),background .6s,border .6s}
body.dark .card{background:var(--surface);border-color:var(--border)}
.card:hover{transform:translateY(-4px);box-shadow:var(--shadow-md);border-color:var(--accent-hover)}
.card-title{margin:0;font-size:var(--fs-1);letter-spacing:2px;text-transform:uppercase;font-weight:700;color:var(--accent)}
.high-impact-note{font-size:var(--fs-1);color:var(--text-faint);margin:var(--space-2) 0 0}
.positioning-wrap{display:flex;flex-direction:column;gap:var(--space-4)}
.metric-block{background:var(--surface-alt);border:1px solid var(--border);border-radius:16px;padding:var(--space-5) var(--space-5) var(--space-4);display:flex;flex-direction:column;gap:var(--space-3);transition:background .6s,border .6s}
.metric-head{display:flex;align-items:center;justify-content:space-between;gap:.5rem;flex-wrap:wrap}
.inline-badge{background:var(--accent);color:#fff;font-size:var(--fs-1);font-weight:600;padding:.25rem .55rem .2rem;border-radius:var(--radius-full);letter-spacing:.5px}
.cot-bars{display:flex;flex-direction:column;gap:.5rem}
.cot-row{display:flex;align-items:center;gap:.75rem;font-size:var(--fs-2)}
.cot-label{flex:0 0 130px;font-weight:600;color:var(--text-soft)}
.cot-bar-wrap{flex:1;display:flex;align-items:center;gap:.5rem}
.cot-bar{position:relative;height:14px;border-radius:7px;overflow:hidden;background:var(--surface)}
body.dark .cot-bar{background:#2d2722}
.cot-bar span{display:block;height:100%;background:linear-gradient(90deg,var(--accent),var(--accent-hover))}
.cot-val{font-size:var(--fs-2);font-weight:600;color:var(--text)}
.delta-positive{color:#2f7d46;font-weight:700}
.delta-negative{color:#b44838;font-weight:700}
.note{font-size:var(--fs-1);color:var(--text-faint);line-height:1.35}
/* Team */
.team-grid{display:grid;gap:var(--space-6);grid-template-columns:repeat(auto-fill,minmax(180px,1fr))}
.team-card{background:var(--surface);border:1px solid var(--border-strong);border-radius:20px;padding:var(--space-6) var(--space-5) var(--space-5);box-shadow:var(--shadow-sm);text-align:center;display:flex;flex-direction:column;gap:var(--space-3);transition:var(--trans),background .6s,border .6s;min-height:100%}
body.dark .team-card{background:var(--surface);border-color:var(--border)}
.team-card:hover{transform:translateY(-4px);box-shadow:var(--shadow-md);border-color:var(--accent)}
.team-avatar{width:68px;height:68px;border-radius:50%;object-fit:cover;margin:0 auto;border:3px solid #fff;box-shadow:0 0 0 3px rgba(178,121,52,.3);background:#eee}
body.dark .team-avatar{box-shadow:0 0 0 3px rgba(209,149,77,.4)}
.team-name{font-size:var(--fs-2);font-weight:600;margin:0}
.team-role{font-size:var(--fs-1);letter-spacing:1px;text-transform:uppercase;font-weight:700;color:var(--accent);margin:0}
.team-principle{font-size:var(--fs-1);color:var(--text-soft);line-height:1.36;margin:0;flex-grow:1;display:flex;align-items:center;justify-content:center}
/* News (live) */
.news-controls{display:flex;flex-wrap:wrap;gap:var(--space-3);margin:0 0 var(--space-6)}
.news-controls input,.news-controls select{padding:.55rem .85rem;font-size:var(--fs-1);border:1px solid var(--border-strong);background:var(--surface-alt);border-radius:var(--radius-full);font-family:var(--font);color:var(--text);transition:var(--trans)}
body.dark .news-controls input,body.dark .news-controls select{background:#2a241f;border-color:var(--border)}
.news-controls input:focus,.news-controls select:focus{box-shadow:var(--focus-ring);outline:none;border-color:var(--accent)}
#newsGrid{display:grid;gap:var(--space-6);grid-template-columns:repeat(auto-fill,minmax(250px,1fr));align-items:stretch}
.news-card{background:var(--surface);border:1px solid var(--border-strong);border-radius:20px;padding:var(--space-5);box-shadow:var(--shadow-sm);display:flex;flex-direction:column;gap:var(--space-3);font-size:var(--fs-2);transition:var(--trans),background .6s,border .6s;position:relative;min-height:100%}
body.dark .news-card{background:var(--surface);border-color:var(--border)}
.news-card:hover{transform:translateY(-4px);box-shadow:var(--shadow-md);border-color:var(--accent)}
.news-meta{display:flex;flex-wrap:wrap;gap:.4rem;font-size:var(--fs-1);text-transform:uppercase;letter-spacing:.65px;color:var(--text-faint);line-height:1.2}
.topic-badge{background:var(--accent);color:#fff;padding:.24rem .58rem .2rem;font-size:var(--fs-1);font-weight:600;letter-spacing:.6px;border-radius:var(--radius-full)}
.news-actions{margin-top:auto;display:flex;gap:var(--space-2)}
.icon-btn{width:30px;height:30px;border:1px solid var(--border-strong);background:var(--surface-alt);border-radius:10px;display:inline-flex;align-items:center;justify-content:center;font-size:var(--fs-2);cursor:pointer;color:var(--accent);transition:var(--trans)}
.icon-btn:hover,.icon-btn.active{background:var(--accent);color:#fff;border-color:var(--accent)}
/* News live bar additions */
.news-live-bar{display:flex;flex-wrap:wrap;gap:.75rem;align-items:center;margin:0 0 var(--space-4)}
.news-live-indicator{display:inline-flex;align-items:center;gap:.4rem;font-size:var(--fs-2);font-weight:600;letter-spacing:.5px;background:var(--surface-alt);padding:.4rem .75rem .35rem;border:1px solid var(--border);border-radius:var(--radius-full)}
.news-live-indicator .dot{width:10px;height:10px;border-radius:50%;background:#d64a32;box-shadow:0 0 0 0 rgba(214,74,50,.65);animation:pulseDot 1.8s ease-in-out infinite}
@keyframes pulseDot{0%{box-shadow:0 0 0 0 rgba(214,74,50,.65)}70%{box-shadow:0 0 0 8px rgba(214,74,50,0)}100%{box-shadow:0 0 0 0 rgba(214,74,50,0)}}
.news-view-tabs{display:inline-flex;gap:.4rem;background:var(--surface-alt);padding:.35rem;border:1px solid var(--border);border-radius:999px}
.news-view-tabs .nv-tab{background:transparent;border:none;padding:.4rem .85rem .38rem;font-size:var(--fs-1);font-weight:600;letter-spacing:.5px;border-radius:999px;cursor:pointer;color:var(--text-soft);transition:var(--trans)}
.news-view-tabs .nv-tab:hover{color:var(--text)}
.news-view-tabs .nv-tab.active{background:var(--accent);color:#fff}
.news-ctrl-btn{background:var(--surface-alt);border:1px solid var(--border);color:var(--accent);font-size:var(--fs-1);font-weight:600;padding:.45rem .85rem .4rem;border-radius:var(--radius-full);cursor:pointer;transition:var(--trans)}
.news-ctrl-btn:hover{background:var(--accent);color:#fff;border-color:var(--accent)}
.news-ctrl-btn[aria-pressed="true"]{background:var(--accent);color:#fff;border-color:var(--accent)}
.news-new-btn{background:var(--accent);color:#fff;border-color:var(--accent);display:none}
.news-new-btn[hidden]{display:none!important}
.news-new-btn:not([hidden]){display:inline-flex}
.impact-badge{font-size:var(--fs-1);font-weight:700;line-height:1;padding:.26rem .55rem .22rem;border-radius:14px;letter-spacing:.5px;background:#bbb;color:#fff;display:inline-flex;align-items:center;justify-content:center}
.impact-0{background:#9f978f}
.impact-1{background:transparent;color:var(--accent);border:1.4px solid var(--accent)}
.impact-2{background:#d28a3d}
.impact-3{background:#c14834}
.news-card[data-paused="true"]{opacity:.65}
.news-sentiment-tag{font-size:var(--fs-1);font-weight:600;padding:.22rem .5rem .18rem;border-radius:12px;background:var(--surface-alt);border:1px solid var(--border);text-transform:uppercase;letter-spacing:.5px}
.news-sentiment-hawkish{color:#c14a3a;border-color:#c14a3a}
.news-sentiment-dovish{color:#378046;border-color:#378046}
.news-sentiment-risk_on{color:#378046;border-color:#378046}
.news-sentiment-risk_off{color:#c14a3a;border-color:#c14a3a}
.news-config{margin-top:.5rem;background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:.9rem 1rem .8rem}
.news-config summary{cursor:pointer;font-weight:600;letter-spacing:.5px;font-size:var(--fs-2);margin-bottom:.4rem}
/* Live Journal (clean) */
.journal-section-head-spacer{margin:var(--space-6) 0 var(--space-5);}
.journal-grid{display:grid;gap:var(--space-6);grid-template-columns:repeat(auto-fill,minmax(260px,1fr))}
.journal-card{background:var(--surface);border:1px solid var(--border-strong);border-radius:22px;padding:var(--space-5);display:flex;flex-direction:column;gap:var(--space-3);position:relative;box-shadow:var(--shadow-sm);transition:var(--trans)}
body.dark .journal-card{background:var(--surface);border-color:var(--border)}
.journal-card:hover{transform:translateY(-4px);box-shadow:var(--shadow-md);border-color:var(--accent-hover)}
.journal-meta{display:flex;flex-wrap:wrap;gap:.45rem;font-size:var(--fs-1);letter-spacing:.6px;text-transform:uppercase;color:var(--text-faint)}
.journal-card h3{margin:.05rem 0 .35rem;font-size:var(--fs-3);line-height:1.25}
.category-pill{background:var(--accent);color:#fff;border-radius:14px;padding:.3rem .65rem .25rem;font-weight:700;letter-spacing:.5px;font-size:var(--fs-1)}
.sentiment-dot{position:absolute;top:8px;right:8px;width:11px;height:11px;border-radius:50%;background:#bbb}
.sentiment-dot[data-sent="1"]{background:#c14a3a}
.sentiment-dot[data-sent="2"]{background:#d38644}
.sentiment-dot[data-sent="3"]{background:#cdb04f}
.sentiment-dot[data-sent="4"]{background:#6aa259}
.sentiment-dot[data-sent="5"]{background:#378046}
.add-entry-panel{background:linear-gradient(140deg,var(--surface),var(--surface-alt));border:1px solid var(--border);border-radius:36px;padding:var(--space-7) var(--space-6);box-shadow:var(--shadow-sm);transition:var(--trans);margin-top:var(--space-8)}
.add-entry-panel summary{cursor:pointer;font-weight:800;letter-spacing:.6px;font-size:var(--fs-3);list-style:none}
.add-entry-panel[open]{box-shadow:var(--shadow-md);border-color:var(--accent)}
.journal-form{display:flex;flex-direction:column;gap:var(--space-6);margin-top:var(--space-5)}
.journal-form-row{display:flex;flex-wrap:wrap;gap:var(--space-4)}
.journal-form input,.journal-form select,.journal-form textarea{padding:.85rem 1.1rem;border:1.5px solid var(--border-strong);border-radius:24px;background:var(--surface-alt);font-family:var(--font);font-size:var(--fs-2);color:var(--text);transition:var(--trans);flex:1 1 230px}
.journal-form textarea{min-height:120px;resize:vertical;line-height:1.45}
.journal-form input:focus,.journal-form select:focus,.journal-form textarea:focus{outline:none;box-shadow:var(--focus-ring);border-color:var(--accent)}
.counter-row{display:flex;justify-content:space-between;font-size:var(--fs-1);color:var(--text-faint);margin-top:-.4rem}
.image-drop{border:2px dashed var(--border-strong);border-radius:26px;padding:var(--space-6);display:flex;flex-direction:column;align-items:center;gap:var(--space-3);text-align:center;font-size:var(--fs-2);color:var(--text-soft);background:var(--surface-alt);cursor:pointer;transition:var(--trans)}
.image-drop.drag{border-color:var(--accent);background:var(--surface-accent);color:var(--accent)}
.preview-strip{display:flex;flex-wrap:wrap;gap:.8rem;margin-top:.35rem}
.preview-item{position:relative;width:100px;height:100px}
.preview-item img{width:100%;height:100%;object-fit:cover;border:2px solid var(--surface);border-radius:16px;box-shadow:0 3px 8px -3px rgba(0,0,0,.25)}
.preview-remove{position:absolute;top:-7px;right:-7px;background:var(--accent);color:#fff;border:none;border-radius:18px;width:24px;height:24px;cursor:pointer;font-size:.72rem;font-weight:700;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 4px rgba(0,0,0,.28)}
.preview-meta{font-size:var(--fs-1);color:var(--text-faint)}
.journal-images{display:grid;grid-template-columns:repeat(auto-fill,minmax(74px,1fr));gap:.5rem;margin-top:.35rem}
.journal-images button{background:none;border:none;padding:0;cursor:pointer}
.journal-images img{width:100%;height:74px;object-fit:cover;border-radius:12px;border:2px solid var(--surface-alt);transition:var(--trans)}
.journal-images img:hover{border-color:var(--accent)}
.lightbox{position:fixed;inset:0;background:rgba(0,0,0,.78);display:flex;align-items:center;justify-content:center;z-index:400;opacity:0;pointer-events:none;transition:.28s}
.lightbox.open{opacity:1;pointer-events:auto}
.lightbox img{max-width:92vw;max-height:86vh;border-radius:22px;box-shadow:0 18px 48px -12px rgba(0,0,0,.7)}
.lightbox button{position:absolute;top:16px;right:16px;background:var(--accent);color:#fff;border:none;border-radius:46px;padding:.65rem 1.15rem .6rem;font-weight:700;cursor:pointer;box-shadow:0 6px 18px -8px rgba(0,0,0,.5)}
/* Framework & Footer */
.cta-box{background:linear-gradient(145deg,var(--surface),var(--surface-alt));border:1px solid var(--border);border-radius:var(--radius-xl);padding:var(--space-9) var(--space-7);text-align:center;box-shadow:var(--shadow-sm);display:flex;flex-direction:column;gap:var(--space-6);transition:var(--trans),background .6s,border .6s;overflow:hidden}
.cta-box:hover{box-shadow:var(--shadow-md);border-color:var(--accent)}
.framework-steps{display:grid;gap:var(--space-5);grid-template-columns:repeat(auto-fill,minmax(160px,1fr));list-style:none;padding:0;margin:var(--space-7) 0 var(--space-8);counter-reset:fw}
.framework-steps li{background:var(--surface);border:1px solid var(--border-strong);border-radius:20px;padding:var(--space-5);font-size:var(--fs-1);display:flex;flex-direction:column;gap:var(--space-3);line-height:1.35;position:relative;box-shadow:var(--shadow-sm);min-height:100%;transition:var(--trans),background .6s,border .6s}
.framework-steps li:hover{transform:translateY(-4px);border-color:var(--accent);box-shadow:var(--shadow-md)}
.framework-steps li::before{counter-increment:fw;content:counter(fw);position:absolute;top:-12px;left:12px;background:var(--accent);color:#fff;font-size:var(--fs-1);font-weight:700;padding:.32rem .58rem .28rem;border-radius:12px;box-shadow:var(--shadow-sm)}
.site-footer{background:var(--surface);border-top:1px solid var(--border);margin-top:var(--space-9);padding:var(--space-9) 0 var(--space-8);transition:background .6s,border .6s}
.footer-grid{display:grid;gap:var(--space-8);grid-template-columns:repeat(auto-fit,minmax(220px,1fr));align-items:start;margin-bottom:var(--space-7)}
.footer-links{list-style:none;padding:0;margin:var(--space-3) 0 0;display:flex;flex-direction:column;gap:.5rem}
.footer-links a{font-size:var(--fs-1);color:var(--text-soft);line-height:1.2}
.footer-links a:hover{color:var(--text)}
#scrollTopBtn{position:fixed;right:clamp(.75rem,1.8vw,1.4rem);bottom:clamp(.75rem,2vw,1.4rem);z-index:120;background:var(--accent);color:#fff;border:none;border-radius:var(--radius-full);padding:.7rem .9rem .65rem;font-size:var(--fs-1);font-weight:700;letter-spacing:.5px;cursor:pointer;box-shadow:0 7px 22px -10px rgba(178,121,52,.6);opacity:0;transform:translateY(12px);transition:var(--trans)}
#scrollTopBtn.visible{opacity:1;transform:translateY(0)}
#scrollTopBtn:hover{background:var(--accent-hover)}
/* Responsiveness */
@media(max-width:640px){
  .hero{padding:var(--space-9) 0 var(--space-8)}
  .panel,.card{padding:var(--space-6) var(--space-5)}
  .framework-steps{gap:var(--space-4)}
  .journal-grid{grid-template-columns:1fr}
  .add-entry-panel{padding:var(--space-6) var(--space-5)}
}
@media(prefers-reduced-motion:reduce){*{animation:none!important;transition:none!important}}
/* Splash */
body.splash-lock{overflow:hidden;height:100vh}
#splash{position:fixed;inset:0;z-index:999;display:flex;align-items:center;justify-content:center;background:radial-gradient(circle at 50% 40%,#ffffff 0%,#f3ece4 60%,#e9dfd3 100%);transition:opacity .6s ease,transform .6s ease}
body.dark #splash{background:radial-gradient(circle at 50% 40%,#2b241e 0%,#221d17 60%,#191510 100%)}
#splash.hide{opacity:0;transform:scale(.985);pointer-events:none}
.splash-inner{display:flex;flex-direction:column;align-items:center;gap:var(--space-6);text-align:center;padding:var(--space-8) var(--space-7)}
.splash-logo{width:88px;height:88px;border-radius:24px;background:linear-gradient(135deg,var(--accent),var(--accent-hover) 55%,var(--accent-warm));box-shadow:0 10px 30px -12px rgba(178,121,52,.55),0 4px 12px rgba(110,70,30,.25);display:flex;align-items:center;justify-content:center;font-size:2.1rem;font-weight:800;color:#fff;letter-spacing:-1px;animation:popIn .9s cubic-bezier(.25,.7,.2,1)}
@keyframes popIn{0%{transform:scale(.6);opacity:0}60%{transform:scale(1.08);opacity:1}100%{transform:scale(1)}}
.splash-title{font-size:clamp(1.55rem,1.1rem + 1.6vw,2.35rem);font-weight:900;letter-spacing:-1.2px;background:linear-gradient(90deg,var(--accent),var(--accent-hover) 50%,var(--accent-warm));-webkit-background-clip:text;color:transparent;background-size:180% 100%;animation:shimmer 3.2s linear infinite;line-height:1.05}
.loading-bar{width:260px;max-width:70vw;height:8px;border-radius:5px;background:#e8ddd2;overflow:hidden;position:relative;box-shadow:inset 0 0 0 1px #decfbe}
body.dark .loading-bar{background:#3a3129;box-shadow:inset 0 0 0 1px #53463c}
.loading-bar span{display:block;height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent-warm));animation:barFill 2.4s cubic-bezier(.45,.8,.25,1) forwards}
@keyframes barFill{0%{width:0%}55%{width:68%}100%{width:100%}}
.splash-skip{position:absolute;right:14px;bottom:14px;background:rgba(0,0,0,.06);color:var(--text-soft);font-size:var(--fs-1);font-weight:600;letter-spacing:.7px;padding:.5rem .85rem .45rem;border:1px solid rgba(0,0,0,.12);border-radius:var(--radius-full);cursor:pointer;opacity:0;transition:.4s}
body.dark .splash-skip{background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.15)}
#splash:hover .splash-skip,.splash-skip:focus-visible{opacity:1}
.splash-skip:hover{background:var(--accent);color:#fff;border-color:var(--accent)}
</style>
</head>
<body class="splash-lock">
<!-- Splash -->
<div id="splash" role="dialog" aria-label="Loading Primus Traders">
  <div class="splash-inner">
    <div class="splash-logo">P</div>
    <div class="splash-title" aria-hidden="true">Primus Traders</div>
    <div class="loading-bar" aria-hidden="true"><span></span></div>
    <button class="splash-skip" id="splashSkip">Skip</button>
  </div>
</div>

<header class="site-header">
  <div class="container nav-wrapper">
    <a href="#" class="logo">
      <span class="logo-mark">P</span>
      <span class="logo-text">Primus<span style="background:linear-gradient(90deg,var(--accent),var(--accent-hover));-webkit-background-clip:text;color:transparent">Traders</span></span>
    </a>
    <nav aria-label="Main navigation" style="display:flex;align-items:center;gap:.75rem;">
      <button class="nav-toggle" aria-expanded="false" aria-controls="navMenu" id="navToggle">
        <span></span><span></span><span></span>
      </button>
      <ul class="nav-links" id="navMenu">
        <li><a class="active" href="#">Home</a></li>
        <li><a href="#marketPulse">Calendar</a></li>
        <li><a href="#team">Traders</a></li>
        <li><a href="#marketNews">News</a></li>
        <li><a href="#liveBlog">Journal</a></li>
        <li><a href="#framework">Framework</a></li>
      </ul>
      <button id="themeToggle" class="theme-toggle" aria-label="Toggle dark mode" title="Toggle dark mode">🌙 Dark</button>
    </nav>
  </div>
</header>

<!-- Hero -->
<section class="hero" aria-labelledby="heroTitle">
  <div class="container hero-grid">
    <div>
      <div class="catalyst-pill" id="todayCatalyst">Today: Loading…</div>
      <h1 id="heroTitle">Empowering Disciplined Traders</h1>
      <p class="lead">High‑impact USD catalyst focus, multi‑asset situational awareness (US100, DXY, ES, Gold), institutional positioning (COT), curated narrative flow and a local execution journal—centered on process over impulse.</p>
      <div style="display:flex;flex-wrap:wrap;gap:var(--space-4);margin:var(--space-6) 0 var(--space-5)">
        <a class="btn" href="#marketPulse">Catalysts</a>
        <a class="btn outline" href="#team">Traders</a>
        <a class="btn ghost" href="#liveBlog">Journal</a>
      </div>
      <ul class="value-points">
        <li>High Impact USD Only</li>
        <li>US100 / DXY / ES / Gold</li>
        <li>COT Positioning</li>
        <li>Local Execution Journal</li>
      </ul>

      <!-- Mini News Widget -->
      <div class="mini-news-widget" id="heroNewsWidget" aria-labelledby="heroNewsHeading">
        <h3 id="heroNewsHeading">Latest Market Headlines</h3>
        <ul class="mini-news-list" id="heroNewsList" aria-live="polite" aria-busy="true">
          <li class="small" style="opacity:.7">Loading…</li>
        </ul>
        <div class="mini-news-actions">
          <a href="#marketNews" class="small">Full Stream →</a>
          <button type="button" id="refreshHeroNews" class="small mini-refresh-btn" aria-label="Refresh headlines">↻</button>
        </div>
      </div>
    </div>
    <div class="panel" id="multiAssetPanel">
      <div>
        <h2 class="subheading">Multi‑Asset Quick Charts</h2>
        <p class="mini-desc">US100 first. Fallback feeds. Timeframe: 60m / 240m / 1D.</p>
      </div>
      <div class="asset-switcher" role="tablist" aria-label="Select asset" id="assetSwitcher">
        <button type="button" class="active" data-asset="US100" aria-selected="true" role="tab">US100</button>
        <button type="button" data-asset="DXY" aria-selected="false" role="tab">DXY</button>
        <button type="button" data-asset="ES" aria-selected="false" role="tab">ES</button>
        <button type="button" data-asset="Gold" aria-selected="false" role="tab">Gold</button>
      </div>
      <div class="tf-switcher" role="tablist" aria-label="Select timeframe" id="tfSwitcher" style="margin-top:.35rem">
        <button type="button" data-int="60" aria-selected="false">60m</button>
        <button type="button" class="active" data-int="240" aria-selected="true">240m</button>
        <button type="button" data-int="D" aria-selected="false">1D</button>
      </div>
      <div class="chart-wrapper loading" id="multiAssetChart" aria-label="Asset price chart"></div>
      <p id="feedBadge" class="small faint" style="margin:0 0 .4rem">Feed: (initialising…)</p>
      <p class="small faint" style="margin:0">Data via TradingView (auto‑fallback feeds & timeframe). Illustrative only. Not investment advice.</p>
    </div>
  </div>
</section>

<!-- Market Pulse -->
<section id="marketPulse" class="section" aria-labelledby="pulseHeading">
  <div class="container">
    <header class="section-header">
      <h2 id="pulseHeading">High‑Impact USD Catalysts & NASDAQ COT Positioning</h2>
      <p>Only USD high‑importance economic events plus current week NASDAQ non‑commercial positioning snapshot.</p>
    </header>
    <div class="pulse-grid">
      <div class="card">
        <h3 class="card-title">Upcoming Events</h3>
        <div id="mainCalendar" class="tradingview-widget-container"></div>
        <p class="high-impact-note">Filter: USD • High Impact.</p>
      </div>
      <div class="card">
        <h3 class="card-title">COT Positioning</h3>
        <div class="positioning-wrap">
          <div class="metric-block" id="cotBlock">
            <div class="metric-head">
              <h4 style="margin:0;">NASDAQ COT <span class="inline-badge" id="cotWeekLabel">Wk</span></h4>
              <div class="small" id="cotDateLabel"></div>
            </div>
            <div class="cot-bars" id="cotBars"></div>
            <div class="note">Non‑commercial net & components (contracts). Δ vs prior week. Data ~3 day lag.</div>
            <div class="small faint" id="cotUpdated" style="margin-top:.25rem;"></div>
          </div>
          <p class="small faint" style="margin:0">Source: CFTC. Auto‑updated weekly.</p>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Team -->
<section id="team" class="section" aria-labelledby="teamHeading">
  <div class="container">
    <header class="section-header">
      <h2 id="teamHeading">Meet the Traders</h2>
      <p>Principles guiding contextual awareness & disciplined execution.</p>
    </header>
    <div class="team-grid">
      <div class="team-card"><img class="team-avatar" src="https://via.placeholder.com/150?text=S" alt="Sajid"><p class="team-name">Sajid</p><p class="team-role">Lead Strategist</p><p class="team-principle">Bias only after catalyst & structural confirmation.</p></div>
      <div class="team-card"><img class="team-avatar" src="https://via.placeholder.com/150?text=M" alt="Mubeen"><p class="team-name">Mubeen</p><p class="team-role">Structure</p><p class="team-principle">Liquidity sweep + rejection > generic pattern names.</p></div>
      <div class="team-card"><img class="team-avatar" src="https://via.placeholder.com/150?text=Sa" alt="Saf"><p class="team-name">Saf</p><p class="team-role">Risk</p><p class="team-principle">Size anchored to volatility & invalidation.</p></div>
      <div class="team-card"><img class="team-avatar" src="https://via.placeholder.com/150?text=So" alt="Sofia"><p class="team-name">Sofia</p><p class="team-role">Execution</p><p class="team-principle">Trigger clarity + no disqualifiers = go.</p></div>
      <div class="team-card"><img class="team-avatar" src="https://via.placeholder.com/150?text=Z" alt="Zain"><p class="team-name">Zain</p><p class="team-role">Psychology</p><p class="team-principle">Track emotional variance like drawdown.</p></div>
    </div>
  </div>
</section>

<!-- Market News Stream -->
<section id="marketNews" class="section" aria-labelledby="newsHeading">
  <div class="container">
    <header class="section-header">
      <h2 id="newsHeading" style="display:flex;align-items:center;gap:.6rem;flex-wrap:wrap">Market News Stream</h2>
      <p>Pin only what shapes the session narrative. Live client-only prototype (Finnhub optional) – will later move to backend.</p>
    </header>

    <div class="news-live-bar" id="newsLiveBar">
      <div class="news-live-indicator" id="newsLiveIndicator">
        <span class="dot" aria-hidden="true"></span><span>Live</span>
      </div>
      <div class="news-view-tabs" role="tablist" aria-label="News view filter" id="newsViewTabs">
        <button type="button" class="nv-tab active" data-view="all" role="tab" aria-selected="true">All</button>
        <button type="button" class="nv-tab" data-view="high" role="tab" aria-selected="false">High Impact</button>
      </div>
      <div class="news-aux-btns" style="display:inline-flex;gap:.5rem;flex-wrap:wrap">
        <button type="button" id="newsPauseBtn" class="news-ctrl-btn" aria-pressed="false" title="Pause auto insert">Pause</button>
        <button type="button" id="newsNewBtn" class="news-ctrl-btn news-new-btn" hidden title="Show new headlines">New (0)</button>
      </div>
    </div>

    <div class="news-controls">
      <input id="newsSearch" type="search" placeholder="Search..." aria-label="Search news">
      <select id="newsSource" aria-label="Source">
        <option value="">All Sources</option>
      </select>
      <select id="newsTopic" aria-label="Topic">
        <option value="">All Topics</option>
        <option value="macro">Macro</option><option value="rates">Rates</option>
        <option value="equities">Equities</option><option value="fx">FX</option>
        <option value="commodities">Commodities</option><option value="sentiment">Sentiment</option>
        <option value="policy">Policy</option>
      </select>
      <button class="btn small outline" id="refreshNews" type="button">Manual Refresh</button>
      <span class="small faint" id="newsTimer">Next: —</span>
      <span class="small faint" id="newsUpdated" aria-live="polite"></span>
    </div>

    <details class="news-config small" id="newsConfig">
      <summary>Config (Key)</summary>
      <label class="small" style="display:flex;gap:.5rem;align-items:center;margin-top:.25rem">
        Finnhub Key
        <input type="password" id="finnhubKeyInput" placeholder="paste & Save" style="flex:1">
      </label>
      <div style="display:flex;gap:.5rem;margin-top:.6rem">
        <button type="button" class="news-ctrl-btn" id="saveFinnhubKeyBtn">Save</button>
        <button type="button" class="news-ctrl-btn" id="clearFinnhubKeyBtn">Clear</button>
        <button type="button" class="news-ctrl-btn" id="testFetchBtn">Test Fetch</button>
      </div>
      <p class="small faint" style="margin-top:.5rem">Key stored locally (localStorage). Exposed in network requests (prototype only).</p>
    </details>

    <div id="pinnedNews" aria-label="Pinned headlines" style="margin:var(--space-5) 0 var(--space-4)"></div>
    <div id="newsGrid" aria-live="polite" aria-busy="true"></div>
    <p class="small faint" style="margin-top:var(--space-5)">Prototype feed. Combining optional Finnhub + local heuristic classification. Educational only. Not investment advice.</p>
  </div>
</section>

<!-- Live Journal (clean, no category buttons) -->
<section id="liveBlog" class="section" aria-labelledby="blogHeading">
  <div class="container">
    <header class="section-header">
      <h2 id="blogHeading">Live Journal</h2>
      <p>Local only. Capture prep, intraday adjustments & post‑session reflections. Screenshots stored privately in your browser.</p>
    </header>

    <div class="journal-section-head-spacer"></div>

    <div class="journal-grid" id="journalGrid" aria-live="polite" aria-busy="true"></div>

    <details class="add-entry-panel" id="addEntryPanel">
      <summary>+ Add Entry</summary>
      <form class="journal-form" id="journalForm" novalidate>
        <div class="journal-form-row">
          <input name="title" required maxlength="120" placeholder="Title">
          <select name="category" required>
            <option value="">Category</option>
            <option>Macro</option><option>Risk</option><option>Structure</option>
            <option>Psychology</option><option>Process</option>
          </select>
          <select name="sentiment" required>
            <option value="">Sentiment (1‑5)</option>
            <option value="1">1 - Stressed</option>
            <option value="2">2 - Cautious</option>
            <option value="3">3 - Neutral</option>
            <option value="4">4 - Focused</option>
            <option value="5">5 - Optimal</option>
          </select>
        </div>

        <textarea name="body" required maxlength="600" placeholder="Insight / scenario / reflection... Use -> for bullets."></textarea>
        <div class="counter-row">
          <span id="charCounter">0 / 600</span>
          <span id="imgCounter">0 images</span>
        </div>

        <label class="image-drop" id="imageDrop">
          <input type="file" accept="image/*" id="imageInput" multiple hidden>
          <span style="font-weight:600;letter-spacing:.55px">Drop or click to add screenshots (max 3)</span>
          <span class="small" style="font-size:var(--fs-1)">Auto compressed • Local only</span>
        </label>
        <div class="preview-strip" id="previewStrip" aria-live="polite"></div>
        <div class="preview-meta" id="previewMeta"></div>

        <div style="display:flex;flex-wrap:wrap;gap:var(--space-4);align-items:center">
          <button class="btn" type="submit">Publish</button>
          <button class="btn outline" type="button" id="seedBtn">Seed</button>
          <button class="btn outline" type="button" id="clearAllJournalBtn">Clear All</button>
        </div>
        <p class="small faint" style="margin:0;color:var(--text-faint)">Entries persist in this browser only (localStorage).</p>
      </form>
    </details>
  </div>
</section>

<!-- Framework -->
<section id="framework" class="section" aria-labelledby="frameworkHeading">
  <div class="container">
    <div class="cta-box">
      <h2 id="frameworkHeading" style="margin:0">Execution Framework Cycle</h2>
      <p class="lead" style="margin:0 auto var(--space-5);max-width:780px">Context → Bias → Risk → Execute → Journal → Metrics → Adapt.</p>
      <ul class="framework-steps">
        <li><strong>1 Intake</strong><span>Macro catalysts + structure map + volatility regime.</span></li>
        <li><strong>2 Bias</strong><span>Scenario + triggers + invalidation clarity.</span></li>
        <li><strong>3 Risk</strong><span>Sizing anchored to volatility & structure distance.</span></li>
        <li><strong>4 Execute</strong><span>Only when criteria stack; skip marginal setups.</span></li>
        <li><strong>5 Journal</strong><span>Fast factual capture with emotional baseline.</span></li>
        <li><strong>6 Metrics</strong><span>Expectancy segmented by regime & setup.</span></li>
        <li><strong>7 Adapt</strong><span>Iterate constraints & filters from feedback.</span></li>
      </ul>
      <a href="#liveBlog" class="btn">Journal Now</a>
    </div>
  </div>
</section>

<footer class="site-footer">
  <div class="container footer-grid">
    <div>
      <h3 style="margin:0 0 var(--space-3);font-size:var(--fs-3)">Primus Traders</h3>
      <p class="small" style="margin:0;max-width:30ch">High‑impact clarity. Process over impulse.</p>
    </div>
    <nav aria-label="Footer navigation">
      <ul class="footer-links">
        <li><a href="#marketPulse">Calendar</a></li>
        <li><a href="#team">Traders</a></li>
        <li><a href="#marketNews">News</a></li>
        <li><a href="#liveBlog">Journal</a></li>
        <li><a href="#framework">Framework</a></li>
      </ul>
    </nav>
    <div class="small"><strong>Disclaimer:</strong> Educational only. No investment advice.</div>
  </div>
  <div class="small" style="text-align:center">© <span id="year"></span> Primus Traders. All rights reserved.</div>
</footer>

<button id="scrollTopBtn" aria-label="Scroll to top">↑</button>

<script src="https://s3.tradingview.com/tv.js" defer></script>
<script>
/* Helpers */
const qs = s => document.querySelector(s);
const qsa = s => [...document.querySelectorAll(s)];
const storage = {
  read:(k,d)=>{try{return JSON.parse(localStorage.getItem(k))??d}catch(_){return d}},
  write:(k,v)=>localStorage.setItem(k,JSON.stringify(v)),
  remove:k=>localStorage.removeItem(k)
};

/* Theme */
const THEME_KEY='primus_theme_pref';
function applyStoredTheme(){
  const pref=storage.read(THEME_KEY,'light');
  if(pref==='dark') document.body.classList.add('dark');
  updateThemeToggleButton();
}
function updateThemeToggleButton(){
  const btn=qs('#themeToggle');
  if(!btn) return;
  const dark=document.body.classList.contains('dark');
  btn.textContent= dark ? '☀️ Light' : '🌙 Dark';
  btn.setAttribute('aria-label', dark? 'Switch to light mode':'Switch to dark mode');
}
function toggleTheme(){
  document.body.classList.toggle('dark');
  storage.write(THEME_KEY,document.body.classList.contains('dark')?'dark':'light');
  updateThemeToggleButton();
  if(assetWidgetBuilt) buildAssetWidgetFor(currentAsset,0,true);
}
document.addEventListener('DOMContentLoaded',()=>qs('#themeToggle')?.addEventListener('click',toggleTheme));

/* Splash */
(function(){
 const splash=qs('#splash'); if(!splash) return;
 const skip=qs('#splashSkip'); const MIN_MS=1800; const start=performance.now();
 function end(){ if(splash.classList.contains('hide')) return;
  splash.classList.add('hide'); splash.setAttribute('aria-hidden','true');
  document.body.classList.remove('splash-lock'); setTimeout(()=>splash.remove(),650);
 }
 skip.addEventListener('click',end); document.addEventListener('keydown',e=>{if(e.key==='Escape') end();});
 const waits=[]; if(document.fonts && document.fonts.ready) waits.push(document.fonts.ready);
 waits.push(new Promise(r=>window.addEventListener('load',r,{once:true})));
 Promise.all(waits).then(()=>{const elapsed=performance.now()-start; setTimeout(end,Math.max(0,MIN_MS-elapsed));});
 setTimeout(end,6000);
})();

/* Nav */
const navToggle=qs('#navToggle'), navMenu=qs('#navMenu');
navToggle?.addEventListener('click',()=>{const open=navMenu.classList.toggle('open'); navToggle.setAttribute('aria-expanded',open);});
document.addEventListener('click',e=>{
 if(!navMenu.contains(e.target)&&!navToggle.contains(e.target)){
  navMenu.classList.remove('open'); navToggle.setAttribute('aria-expanded','false');
 }
});

/* Year & scroll top */
qs('#year').textContent=new Date().getFullYear();
const scrollBtn=qs('#scrollTopBtn');
window.addEventListener('scroll',()=>scrollBtn.classList.toggle('visible',window.scrollY>650));

/* Catalyst sample */
const catalysts=[
 {label:"US CPI",m:90,exp:"3.1% YoY"},
 {label:"FOMC Minutes",m:180,exp:"Tone watch"},
 {label:"NFP",m:240,exp:"+180k"},
 {label:"Retail Sales",m:150,exp:"+0.4%"}
];
qs('#todayCatalyst').textContent=(()=>{
 const pick=catalysts[Math.floor(Math.random()*catalysts.length)];
 return `Today: ${pick.label} in ${pick.m}m | Exp ${pick.exp}`;
})();

/* Multi-Asset Charts */
let assetWidgetBuilt=false;
let currentAsset='US100';
let currentInterval='240';
const assets={
  US100:['CAPITALCOM:US100','OANDA:NAS100USD','TVC:NDX'],
  DXY:['CAPITALCOM:DXY','FX_IDC:USDOLLAR','TVC:DXY'],
  ES:['CAPITALCOM:US500','OANDA:SPX500USD','CME_MINI:ES1!'],
  Gold:['OANDA:XAUUSD','CAPITALCOM:GOLD','COMEX:GC1!']
};
let activeFeed=null;
function updateFeedBadge(){
  const badge=qs('#feedBadge');
  if(!badge)return;
  badge.textContent='Feed: '+(activeFeed||'—')+' | TF: '+(currentInterval==='D'?'1D':currentInterval+'m');
}
function buildAssetWidgetFor(assetKey, attempt=0, themeRebuild=false){
  if(!window.TradingView)return;
  const el=qs('#multiAssetChart');
  const list=assets[assetKey]||[];
  if(attempt>=list.length){
    el.classList.remove('loading');
    el.innerHTML='<div style="padding:1rem;font-size:var(--fs-2);color:var(--text-soft)">All fallback feeds failed for '+assetKey+'</div>';
    activeFeed=null;updateFeedBadge();return;
  }
  const symbol=list[attempt];
  activeFeed=symbol;updateFeedBadge();
  el.classList.add('loading'); el.innerHTML="";
  const theme=document.body.classList.contains('dark')?'dark':'light';
  new TradingView.widget({
    symbol, interval: currentInterval, timezone:"Etc/UTC",
    theme, style:"1", locale:"en", hide_top_toolbar:true,
    hide_legend:true, enable_publishing:false, allow_symbol_change:false,
    container_id:"multiAssetChart", autosize:true
  });
  setTimeout(()=>{
    if(/only available on tradingview/i.test(el.textContent||""))
      buildAssetWidgetFor(assetKey,attempt+1,themeRebuild);
    else { el.classList.remove('loading'); activeFeed=symbol; updateFeedBadge(); }
  }, themeRebuild?900:1700);
}
(function initAsset(){
  const sw=qs('#assetSwitcher');
  sw.addEventListener('click',e=>{
    const b=e.target.closest('button[data-asset]'); if(!b) return;
    const asset=b.dataset.asset;
    if(asset===currentAsset) return;
    currentAsset=asset;
    sw.querySelectorAll('button').forEach(btn=>{
      const act=btn.dataset.asset===currentAsset;
      btn.classList.toggle('active',act);
      btn.setAttribute('aria-selected',act);
    });
    buildAssetWidgetFor(currentAsset,0);
  });
  const tf=qs('#tfSwitcher');
  tf.addEventListener('click',e=>{
    const b=e.target.closest('button[data-int]'); if(!b)return;
    const interval=b.dataset.int;
    if(interval===currentInterval) return;
    currentInterval=interval;
    tf.querySelectorAll('button').forEach(btn=>{
      const act=btn.dataset.int===currentInterval;
      btn.classList.toggle('active',act);
      btn.setAttribute('aria-selected',act);
    });
    buildAssetWidgetFor(currentAsset,0);
  });
  new IntersectionObserver(entries=>{
    entries.forEach(en=>{
      if(en.isIntersecting && !assetWidgetBuilt && window.TradingView){
        assetWidgetBuilt=true; buildAssetWidgetFor(currentAsset,0);
      }
    });
  },{rootMargin:"200px"}).observe(qs('#multiAssetChart'));
})();

/* Economic Calendar */
function buildCalendar(){
 const t=qs('#mainCalendar'); if(!t) return;
 t.innerHTML="";
 const s=document.createElement('script');
 s.src='https://s3.tradingview.com/external-embedding/embed-widget-events.js';
 s.async=true;
 s.innerHTML=JSON.stringify({colorTheme:document.body.classList.contains('dark')?"dark":"light",isTransparent:false,width:"100%",height:"480",locale:"en",importanceFilter:"1",currencyFilter:"USD"});
 t.appendChild(s);
}
document.addEventListener('DOMContentLoaded',buildCalendar);

/* COT */
const SENT_KEY='primus_sentiment_cache_v1';
function formatDelta(curr, prev){
 const diff=curr-prev;
 if(!isFinite(diff)) return {text:"",cls:""};
 if(Math.abs(diff)<0.0001) return {text:"0",cls:""};
 const cls=diff>0?'delta-positive':'delta-negative';
 const sign=diff>0?'+':'';
 return {text:sign+(Math.abs(diff)<1?diff.toFixed(2):diff.toLocaleString()),cls};
}
function renderCOT(cot){
 const barsEl=qs('#cotBars');
 qs('#cotWeekLabel').textContent="Wk";
 qs('#cotDateLabel').textContent="Week Ending "+cot.weekEnding;
 barsEl.innerHTML="";
 cot.rows.forEach(r=>{
  const delta=formatDelta(r.value,r.prev);
  const pct=Math.min(100,Math.abs(r.value)/r.max*100);
  const pos='linear-gradient(90deg,var(--accent),var(--accent-hover))';
  const neg='linear-gradient(90deg,#b44838,#d36a58)';
  const row=document.createElement('div');
  row.className='cot-row';
  row.innerHTML=`<div class="cot-label">${r.label}</div>
    <div class="cot-bar-wrap">
      <div class="cot-bar" style="flex:1">
        <span style="width:${pct}%;background:${r.value>=0?pos:neg}"></span>
      </div>
      <div class="cot-val">${r.value.toLocaleString()} <span class="${delta.cls}" style="font-size:var(--fs-1)">${delta.text}</span></div>
    </div>`;
  barsEl.appendChild(row);
 });
}
async function fetchSentiment(){
 try{
   const res=await fetch('data/sentiment.json?ts='+Date.now(),{cache:'no-store'});
   if(res.ok) return await res.json();
 }catch(_){}
 return null;
}
function applySentiment(json,persist=true){
 if(!json||!json.cot)return;
 renderCOT(json.cot);
 if(json.updated){
   const upd=qs('#cotUpdated');
   if(upd){
     const dt=new Date(json.updated);
     upd.textContent='Updated: '+(isNaN(dt)?json.updated:dt.toLocaleString());
   }
 }
 if(persist) storage.write(SENT_KEY,json);
}
(async function initSentiment(){
 const cached=storage.read(SENT_KEY,null);
 if(cached) applySentiment(cached,false);
 const fresh=await fetchSentiment();
 if(fresh) applySentiment(fresh);
 else if(!cached){
   applySentiment({
     cot:{weekEnding:"(sample)",rows:[
       {label:"Non-Comm Net",value:48000,prev:45500,max:80000},
       {label:"Non-Comm Long",value:123000,prev:122000,max:180000},
       {label:"Non-Comm Short",value:75000,prev:76500,max:180000}
     ]},
     updated:new Date().toISOString()
   },false);
 }
})();

/* Live News System */
(function(){
  const grid=qs('#newsGrid');
  if(!grid) return;
  const pinnedWrap=qs('#pinnedNews');
  const searchInput=qs('#newsSearch');
  const srcSelect=qs('#newsSource');
  const topicSelect=qs('#newsTopic');
  const updatedLabel=qs('#newsUpdated');
  const timerLabel=qs('#newsTimer');
  const refreshBtn=qs('#refreshNews');
  const pauseBtn=qs('#newsPauseBtn');
  const newBtn=qs('#newsNewBtn');
  const tabsWrap=qs('#newsViewTabs');
  const keyInput=qs('#finnhubKeyInput');
  const saveKeyBtn=qs('#saveFinnhubKeyBtn');
  const clearKeyBtn=qs('#clearFinnhubKeyBtn');
  const testFetchBtn=qs('#testFetchBtn');
  const heroList=qs('#heroNewsList');
  const heroRefresh=qs('#refreshHeroNews');

  const PIN_KEY='primus_pins_v2';
  let pinnedIds=new Set(storage.read(PIN_KEY,[]));
  let newsStore=[]; let newsIndex=new Map();
  let sourcesSet=new Set();
  let pendingQueue=[]; let paused=false;
  let currentView='all'; let rollingHours=6;
  let pollTimer=null; let lastPollHadNew=false;
  let consecutiveEmpty=0; let newestTs=0;
  let visible=!document.hidden;

  const LOCAL_FH_KEY_STORE='primus_finnhub_key';
  function getFinnhubKey(){return localStorage.getItem(LOCAL_FH_KEY_STORE)||null;}
  function setFinnhubKey(v){v?localStorage.setItem(LOCAL_FH_KEY_STORE,v):localStorage.removeItem(LOCAL_FH_KEY_STORE);}
  keyInput.value=getFinnhubKey()||'';
  saveKeyBtn.addEventListener('click',()=>{const v=keyInput.value.trim(); if(!v){alert('Paste key');return;} setFinnhubKey(v); manualRefresh(true);});
  clearKeyBtn.addEventListener('click',()=>{setFinnhubKey(null); keyInput.value=''; alert('Key cleared');});
  testFetchBtn.addEventListener('click',()=>manualRefresh(true));
  heroRefresh?.addEventListener('click',()=>manualRefresh(true));

  const escapeHtml=s=>(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  function relativeTime(ts){
    const diff=Date.now()-ts,m=Math.floor(diff/60000);
    if(m<1)return Math.floor(diff/1000)+'s ago';
    if(m<60)return m+'m ago';
    const h=Math.floor(m/60); if(h<24)return h+'h ago';
    return Math.floor(h/24)+'d ago';
  }
  function classifyTopics(t){
    const s=t.toLowerCase(); const set=new Set();
    if(/fed|fomc|cpi|pce|minutes|powell|ism|nfp|payroll|gdp/.test(s)) set.add('macro');
    if(/treasury|yield|bond|curve|rates|hike|cut/.test(s)) set.add('rates');
    if(/nasdaq|equity|stock|s&p|dow|earnings|shares/.test(s)) set.add('equities');
    if(/\bfx\b|forex|usd|dollar|eur|jpy|gbp|currency/.test(s)) set.add('fx');
    if(/gold|xau|oil|wti|brent|copper|commodit/.test(s)) set.add('commodities');
    if(/sentiment|fear|greed|risk-on|risk off|volatility/.test(s)) set.add('sentiment');
    if(/policy|white house|congress|tariff|sanction/.test(s)) set.add('policy');
    if(!set.size) set.add('macro');
    return [...set];
  }
  function impactScore(headline,source){
    let score=0; const h=headline.toLowerCase(), so=source.toLowerCase();
    if(/cpi|nfp|nonfarm|payroll|fomc|powell|core pce|ism|minutes/.test(h)) score+=2;
    if(/surge|spike|plunge|unexpected|hawkish|dovish/.test(h)) score+=1;
    if(/federal reserve|bls|bea/.test(so)) score+=1;
    return Math.min(3,Math.max(0,score));
  }
  function sentimentClass(h){
    const s=h.toLowerCase();
    if(/hawkish|rate hike|tighten|sticky inflation|strong labor/.test(s)) return 'hawkish';
    if(/dovish|rate cut|easing|cooling inflation|weak labor/.test(s)) return 'dovish';
    if(/selloff|slump|flight to safety|volatility spike|fear/.test(s)) return 'risk_off';
    if(/rally|bid|risk-on|broad gains|bounce/.test(s)) return 'risk_on';
    return 'neutral';
  }
  function instrumentMap(h,imp){
    const s=h.toLowerCase(); const set=new Set();
    if(/nasdaq|tech/.test(s)) set.add('US100');
    if(/dollar|usd|greenback/.test(s)) set.add('DXY');
    if(/treasury|yield|bond|curve/.test(s)) set.add('ES');
    if(/gold|xau|bullion/.test(s)) set.add('XAUUSD');
    if(!set.size && imp>=2) ['US100','DXY','ES','XAUUSD'].forEach(i=>set.add(i));
    return [...set];
  }
  async function fetchFinnhub(){
    const key=getFinnhubKey(); if(!key) return [];
    try{
      const res=await fetch('https://finnhub.io/api/v1/news?category=general&token='+encodeURIComponent(key),{cache:'no-store'});
      if(!res.ok) throw new Error('status '+res.status);
      const data=await res.json(); if(!Array.isArray(data)) return [];
      const out=[];
      for(const r of data){
        if(!r||!r.id||!r.headline) continue;
        const id='fh-'+r.id; if(newsIndex.has(id)) continue;
        const head=r.headline.trim();
        const source=(r.source||'Finnhub').trim();
        const imp=impactScore(head,source);
        out.push({
          id, ts:(r.datetime||0)*1000, source,
          headline:head, summary:r.summary?.trim()||null, url:r.url||null,
          topics:classifyTopics(head),
          impact:imp,
          sentiment:sentimentClass(head),
          instruments:instrumentMap(head,imp)
        });
      }
      return out;
    }catch(e){
      console.warn('[Finnhub]',e.message); return [];
    }
  }
  function mockAdapter(){
    const now=Date.now();
    const base=[
      'Placeholder: Monitoring CPI expectations drift',
      'Placeholder: Yield curve modest re‑steepening',
      'Placeholder: Dollar consolidates ahead of data',
      'Placeholder: Gold holds bid amid policy uncertainty'
    ];
    return base.map((t,i)=>{
      const id='mock-'+(now-i*60000);
      if(newsIndex.has(id)) return null;
      const imp=impactScore(t,'Mock');
      return {
        id, ts:now-i*60000, source:'Mock', headline:t,
        summary:null, url:null,
        topics:classifyTopics(t),
        impact:imp,
        sentiment:sentimentClass(t),
        instruments:instrumentMap(t,imp)
      };
    }).filter(Boolean);
  }
  async function fetchAllSources(){
    const fh=await fetchFinnhub();
    if(fh.length) return fh;
    return mockAdapter();
  }
  function addItems(items){
    if(!items.length)return;
    items.forEach(it=>{
      newsIndex.set(it.id,it);
      newsStore.push(it); sourcesSet.add(it.source);
    });
    const cutoff=Date.now()-rollingHours*3600*1000;
    newsStore=newsStore.filter(n=>n.ts>=cutoff).sort((a,b)=>b.ts-a.ts);
    updateSourceOptions(); queueRender(items); updateHero();
  }
  function updateSourceOptions(){
    const existing=[...srcSelect.options].map(o=>o.value);
    sourcesSet.forEach(s=>{
      if(!existing.includes(s)){
        const opt=document.createElement('option');
        opt.value=s; opt.textContent=s; srcSelect.appendChild(opt);
      }
    });
  }
  function queueRender(items){
    if(paused || !isNearTop()){ pendingQueue.push(...items); updateNewButton(); }
    else insertItems(items);
  }
  function updateNewButton(){
    if(pendingQueue.length){ newBtn.hidden=false; newBtn.textContent='New ('+pendingQueue.length+')'; }
    else newBtn.hidden=true;
  }
  function isNearTop(){return window.scrollY<250;}
  function filterPass(item){
    const q=(searchInput.value||'').trim().toLowerCase();
    const src=srcSelect.value; const topic=topicSelect.value;
    if(currentView==='high' && item.impact<2) return false;
    if(q && !(item.headline.toLowerCase().includes(q)||(item.summary||'').toLowerCase().includes(q))) return false;
    if(src && item.source!==src) return false;
    if(topic && !item.topics.includes(topic)) return false;
    return true;
  }
  function renderAll(){
    grid.setAttribute('aria-busy','true');
    grid.innerHTML='';
    let any=false;
    newsStore.forEach((it,i)=>{
      if(!filterPass(it)) return;
      grid.appendChild(buildCard(it,i)); any=true;
    });
    if(!any){
      const d=document.createElement('div'); d.className='small faint'; d.textContent='No matching headlines.'; grid.appendChild(d);
    }
    grid.setAttribute('aria-busy','false');
    updateNewButton();
  }
  function insertItems(items){
    const frag=document.createDocumentFragment();
    const filtered=items.filter(filterPass);
    filtered.forEach((it,i)=>frag.appendChild(buildCard(it,i,true)));
    if(filtered.length) grid.insertBefore(frag,grid.firstChild);
    updateRelativeTimes();
  }
  function sentimentBadgeClass(sent){return'news-sentiment-tag news-sentiment-'+sent.replace('_','');}
  function buildCard(it,idx){
    const card=document.createElement('article');
    card.className='news-card fade-in';
    card.style.animationDelay=(idx*25)+'ms';
    card.dataset.id=it.id;
    if(paused) card.dataset.paused='true';
    const impactCls='impact-badge impact-'+it.impact;
    const sentCls=sentimentBadgeClass(it.sentiment);
    const topicsHtml=it.topics.map(t=>'<span class="topic-badge">'+escapeHtml(t)+'</span>').join('');
    card.innerHTML=`
      <div class="news-meta">
        <span class="${impactCls}" title="Impact score ${it.impact}">${it.impact}</span>
        ${topicsHtml}
        <span>${escapeHtml(it.source)}</span>
        <span class="rt" data-ts="${it.ts}">${relativeTime(it.ts)}</span>
      </div>
      <h3 style="margin:.3rem 0 .4rem;font-size:var(--fs-3);line-height:1.25">${escapeHtml(it.headline)}</h3>
      ${it.summary?`<p style="margin:0 0 .55rem;color:var(--text-soft);font-size:var(--fs-2);line-height:1.4">${escapeHtml(it.summary)}</p>`:''}
      <div style="display:flex;flex-wrap:wrap;gap:.45rem;align-items:center;margin-bottom:.4rem">
        <span class="${sentCls}">${it.sentiment.replace('_',' ')}</span>
        ${it.url?`<a href="${escapeHtml(it.url)}" target="_blank" rel="noopener" class="small" style="font-weight:600">Source ↗</a>`:''}
      </div>
      <div class="news-actions">
        <button class="icon-btn pin-btn ${pinnedIds.has(it.id)?'active':''}" data-id="${it.id}" aria-label="Pin headline">★</button>
      </div>`;
    return card;
  }
  function renderPinned(){
    pinnedWrap.innerHTML='';
    const pinned=newsStore.filter(i=>pinnedIds.has(i.id)).sort((a,b)=>b.ts-a.ts).slice(0,18);
    if(!pinned.length){
      const d=document.createElement('div'); d.className='small faint'; d.textContent='No pinned.'; pinnedWrap.appendChild(d); return;
    }
    pinned.forEach(p=>{
      const el=document.createElement('div');
      el.className='small'; el.style.display='flex'; el.style.gap='6px'; el.style.alignItems='center';
      el.innerHTML=`<span class="topic-badge">${escapeHtml(p.topics[0]||'macro')}</span><strong style="font-size:var(--fs-1)">${escapeHtml(p.headline)}</strong>`;
      pinnedWrap.appendChild(el);
    });
  }
  function updateRelativeTimes(){qsa('.news-card .rt').forEach(el=>{const ts=+el.dataset.ts; el.textContent=relativeTime(ts);});}
  setInterval(updateRelativeTimes,15000);

  function updateHero(){
    if(!heroList) return;
    heroList.setAttribute('aria-busy','true'); heroList.innerHTML='';
    const top=newsStore.slice(0,4);
    if(!top.length){
      heroList.innerHTML='<li class="small" style="opacity:.7">No headlines.</li>';
      heroList.setAttribute('aria-busy','false'); return;
    }
    top.forEach(n=>{
      const li=document.createElement('li');
      li.innerHTML=`<span class="topic">${escapeHtml(n.topics[0]||'macro')}</span><a href="#marketNews" data-jump-news="${n.id}" title="View in full stream">${escapeHtml(n.headline)}</a>`;
      heroList.appendChild(li);
    });
    heroList.setAttribute('aria-busy','false');
  }
  document.addEventListener('click',e=>{
    const link=e.target.closest('a[data-jump-news]'); if(!link)return;
    setTimeout(()=>{
      const id=link.dataset.jumpNews;
      const card=qsa('.news-card').find(c=>c.dataset.id===id);
      if(card){
        card.style.outline='2px solid var(--accent)';
        card.style.outlineOffset='2px';
        setTimeout(()=>card.style.outline='',1800);
      }
    },80);
  });

  function deb(fn,ms){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms);};}
  const reRender=deb(()=>{renderAll();renderPinned();},160);
  searchInput.addEventListener('input',reRender);
  srcSelect.addEventListener('change',reRender);
  topicSelect.addEventListener('change',reRender);
  tabsWrap.addEventListener('click',e=>{
    const b=e.target.closest('.nv-tab'); if(!b)return;
    if(b.dataset.view===currentView) return;
    currentView=b.dataset.view;
    tabsWrap.querySelectorAll('.nv-tab').forEach(btn=>{
      const act=btn.dataset.view===currentView;
      btn.classList.toggle('active',act);
      btn.setAttribute('aria-selected',act);
    });
    renderAll();
  });
  pauseBtn.addEventListener('click',()=>{
    paused=!paused;
    pauseBtn.setAttribute('aria-pressed',paused?'true':'false');
    pauseBtn.textContent=paused?'Resume':'Pause';
    if(!paused && pendingQueue.length){
      const flush=[...pendingQueue]; pendingQueue.length=0; updateNewButton(); insertItems(flush);
    }
    qsa('.news-card').forEach(c=>{if(paused)c.dataset.paused='true';else c.removeAttribute('data-paused');});
  });
  newBtn.addEventListener('click',()=>{
    const flush=[...pendingQueue]; pendingQueue.length=0; updateNewButton();
    window.scrollTo({top:grid.getBoundingClientRect().top+window.scrollY-120,behavior:'smooth'});
    insertItems(flush);
  });
  grid.addEventListener('click',e=>{
    const pin=e.target.closest('.pin-btn'); if(pin){
      const id=pin.dataset.id;
      pinnedIds.has(id)?pinnedIds.delete(id):pinnedIds.add(id);
      storage.write(PIN_KEY,[...pinnedIds]); pin.classList.toggle('active'); renderPinned();
    }
  });
  refreshBtn.addEventListener('click',()=>manualRefresh(true));

  const BASE_VISIBLE=60000, BASE_HIDDEN=180000, QUIET=90000, BURST=30000;
  function scheduleNext(ms){
    if(pollTimer) clearTimeout(pollTimer);
    timerLabel.textContent='Next: '+Math.round(ms/1000)+'s';
    pollTimer=setTimeout(runPoll,ms);
  }
  async function runPoll(){
    const items=await fetchAllSources();
    const newOnes=items.filter(it=>!newsIndex.has(it.id));
    if(newOnes.length){
      addItems(newOnes);
      newestTs=Math.max(newestTs,...newOnes.map(n=>n.ts));
      lastPollHadNew=true; consecutiveEmpty=0;
      updatedLabel.textContent='Updated '+new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    }else{
      lastPollHadNew=false; consecutiveEmpty++;
    }
    let next=visible?BASE_VISIBLE:BASE_HIDDEN;
    if(!lastPollHadNew && consecutiveEmpty>=5) next=QUIET;
    if(lastPollHadNew && newOnes.some(n=>n.impact>=2)) next=BURST;
    scheduleNext(next);
  }
  function manualRefresh(force){
    consecutiveEmpty=0; lastPollHadNew=false;
    if(force){ if(pollTimer) clearTimeout(pollTimer); runPoll(); }
  }
  document.addEventListener('visibilitychange',()=>{visible=!document.hidden; manualRefresh(true);});
  window.addEventListener('scroll',()=>{
    if(isNearTop() && pendingQueue.length && !paused){
      const flush=[...pendingQueue]; pendingQueue.length=0; updateNewButton(); insertItems(flush);
    }
  });
  function seed(){ addItems(mockAdapter()); renderAll(); renderPinned(); updateHero(); }
  seed(); runPoll();
  window.__newsDebug={newsStore,manualRefresh,newsIndex};
})();

/* Live Journal Clean */
(function(){
  const BLOG_KEY='primus_journal_clean_v1';
  const grid=qs('#journalGrid');
  const form=qs('#journalForm');
  const charCounter=qs('#charCounter');
  const imgCounter=qs('#imgCounter');
  const imageInput=qs('#imageInput');
  const imageDrop=qs('#imageDrop');
  const previewStrip=qs('#previewStrip');
  const previewMeta=qs('#previewMeta');
  const seedBtn=qs('#seedBtn');
  const clearBtn=qs('#clearAllJournalBtn');
  const panel=qs('#addEntryPanel');
  let images=[];
  const MAX_IMAGES=3, MAX_WIDTH=900, JPEG_Q=.75;
  const seedPosts=[
    {id:'seed1',title:'Session Prep',category:'Process',body:'Overnight narrative -> key catalyst -> structure zones.\n-> Primary scenario\n-> Alternate invalidation',sentiment:'4',images:[],ts:Date.now()-1000*60*160},
    {id:'seed2',title:'Risk Framing',category:'Risk',body:'ATR +13% vs 30d. Per trade risk trimmed to 0.55R.',sentiment:'3',images:[],ts:Date.now()-1000*60*120},
    {id:'seed3',title:'Mindset Check',category:'Psychology',body:'Energy 7/10. Watch early FOMO after open.',sentiment:'4',images:[],ts:Date.now()-1000*60*85},
  ];
  function load(){const r=storage.read(BLOG_KEY,null); if(!r){storage.write(BLOG_KEY,seedPosts); return [...seedPosts];} return r;}
  function save(list){storage.write(BLOG_KEY,list);}
  function relativeTime(ts){const d=Date.now()-ts,m=Math.floor(d/60000); if(m<1)return Math.floor(d/1000)+'s ago'; if(m<60)return m+'m ago'; const h=Math.floor(m/60); if(h<24)return h+'h ago'; return Math.floor(h/24)+'d ago';}
  function escapeHtml(s){return (s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}
  function render(){
    grid.setAttribute('aria-busy','true'); grid.innerHTML='';
    const posts=load().sort((a,b)=>b.ts-a.ts);
    if(!posts.length){
      const d=document.createElement('div'); d.className='small'; d.style.fontSize='var(--fs-3)'; d.textContent='No entries.'; grid.appendChild(d);
    } else posts.forEach((p,i)=>grid.appendChild(buildCard(p,i)));
    grid.setAttribute('aria-busy','false');
  }
  function buildCard(p,i){
    const el=document.createElement('article');
    el.className='journal-card fade-in'; el.style.animationDelay=(i*32)+'ms';
    const body=p.body.replace(/^->\s?/gm,'• ');
    el.innerHTML=`
      <span class="sentiment-dot" data-sent="${p.sentiment||'3'}"></span>
      <div class="journal-meta">
        <span class="category-pill">${escapeHtml(p.category)}</span>
        <span data-ts="${p.ts}" class="rt">${relativeTime(p.ts)}</span>
        <span>${p.sentiment?('S'+p.sentiment):''}</span>
      </div>
      <h3>${escapeHtml(p.title)}</h3>
      <p style="margin:0;color:var(--text-soft);white-space:pre-wrap;line-height:1.42">${escapeHtml(body)}</p>
      ${p.images?.length?imageBlock(p.images):''}
    `;
    return el;
  }
  function imageBlock(imgs){
    return `<div class="journal-images">`+imgs.map((im,i)=>`
      <button type="button" class="img-view-btn" data-img="${encodeURIComponent(im.data)}" title="View image ${i+1}">
        <img src="${im.data}" alt="Screenshot">
      </button>`).join('')+`</div>`;
  }
  function fileToDataURL(f){return new Promise((res,rej)=>{const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(f);});}
  async function compress(file){
    const dataUrl=await fileToDataURL(file);
    const img=new Image(); img.src=dataUrl; await img.decode();
    let {width,height}=img;
    if(width>MAX_WIDTH){height=Math.round(height*(MAX_WIDTH/width)); width=MAX_WIDTH;}
    const cvs=document.createElement('canvas'); cvs.width=width; cvs.height=height;
    cvs.getContext('2d').drawImage(img,0,0,width,height);
    const out=cvs.toDataURL('image/jpeg',JPEG_Q);
    return {data:out,width,height,name:file.name,size:Math.round((out.length*3/4)/1024)};
  }
  async function handleFiles(list){
    const allow=MAX_IMAGES-images.length;
    const files=[...list].slice(0,allow);
    for(const f of files){
      if(!/^image\//i.test(f.type)) continue;
      try{images.push(await compress(f));}catch(e){console.warn('img fail',e);}
    }
    updatePreview();
  }
  function updatePreview(){
    previewStrip.innerHTML='';
    images.forEach((im,i)=>{
      const w=document.createElement('div'); w.className='preview-item';
      w.innerHTML=`<img src="${im.data}" alt="Preview ${i+1}">
      <button class="preview-remove" data-idx="${i}" aria-label="Remove image">×</button>`;
      previewStrip.appendChild(w);
    });
    const kb=images.reduce((a,b)=>a+b.size,0);
    previewMeta.textContent=images.length?`${images.length} image${images.length>1?'s':''} • ~${kb} KB`:'';
    imgCounter.textContent=images.length+' image'+(images.length!==1?'s':'');
  }
  form.body.addEventListener('input',()=>charCounter.textContent=form.body.value.length+' / 600');
  imageDrop.addEventListener('click',()=>imageInput.click());
  imageDrop.addEventListener('dragover',e=>{e.preventDefault();imageDrop.classList.add('drag');});
  imageDrop.addEventListener('dragleave',()=>imageDrop.classList.remove('drag'));
  imageDrop.addEventListener('drop',async e=>{
    e.preventDefault();imageDrop.classList.remove('drag');await handleFiles(e.dataTransfer.files);
  });
  imageInput.addEventListener('change',async e=>{
    await handleFiles(e.target.files); imageInput.value='';
  });
  previewStrip.addEventListener('click',e=>{
    const rm=e.target.closest('.preview-remove'); if(rm){images.splice(+rm.dataset.idx,1);updatePreview();}
  });
  form.addEventListener('submit',e=>{
    e.preventDefault();
    const fd=new FormData(form);
    const title=fd.get('title').toString().trim();
    const category=fd.get('category').toString();
    const body=fd.get('body').toString().trim();
    const sentiment=fd.get('sentiment').toString();
    if(!title||!category||!body||!sentiment) return;
    const posts=load();
    const entry={id:'p-'+Date.now(),title,category,body,sentiment,images:[...images],ts:Date.now()};
    posts.push(entry);
    try{save(posts);}catch(err){
      alert('Storage full; saving without images.');
      entry.images=[]; save(posts);
    }
    images.length=0; updatePreview(); form.reset(); charCounter.textContent='0 / 600'; render(); panel.open=false;
  });
  seedBtn.addEventListener('click',()=>{
    if(!confirm('Add sample seed entries?')) return;
    const posts=load();
    seedPosts.forEach(s=>{if(!posts.find(p=>p.id===s.id)) posts.push({...s,ts:Date.now()-Math.random()*1000*60*120});});
    save(posts); render();
  });
  clearBtn.addEventListener('click',()=>{
    if(!confirm('Clear ALL journal entries?')) return;
    save([]); render();
  });
  const lb=document.createElement('div');
  lb.className='lightbox';
  lb.innerHTML='<img alt="Full view"><button type="button" aria-label="Close image">Close</button>';
  document.body.appendChild(lb);
  const lbImg=lb.querySelector('img');
  lb.addEventListener('click',e=>{if(e.target===lb||e.target.tagName==='BUTTON')closeLB();});
  function openLB(src){lbImg.src=src; lb.classList.add('open');}
  function closeLB(){lb.classList.remove('open'); lbImg.src='';}
  grid.addEventListener('click',e=>{
    const btn=e.target.closest('.img-view-btn'); if(!btn)return;
    openLB(decodeURIComponent(btn.dataset.img));
  });
  setInterval(()=>qsa('.journal-card .rt').forEach(el=>{
    const ts=+el.dataset.ts; el.textContent=relativeTime(ts);
  }),15000);
  applyStoredTheme();
  render();
})();

/* Init theme after content */
applyStoredTheme();
</script>
</body>
</html>
